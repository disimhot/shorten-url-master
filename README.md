# Сервис для сокращения ссылок

API сервиса помогает сократить ссылки пользователям, предоставляет информацию по short codes, а также умеет удалять
ссылки, которые долго не были использованы.

------

Ссылка на сервис: [https://short-url-service.onrender.com](https://shorten-url-master.onrender.com/docs)

Render не поддерживает docker-compose, поэтому работа сервиса продемонстрирована в разделе
[Демонстрация](#Демонстрация)

-----

### Установка:

1. Установить все зависимости pip install -r requirements.txt
2. Запустить docker-compose up

-----

### Конфигурация

1. Версия Python 3.12
2. База данных: postgresql. Создаются три таблицы User, Link, LinkArchive для хранения информации по пользователям,
   линкам и удаленным линкам.
3. Распределенная система: Celery. Создается Celery-таска для удаления неиспользуемых ссылок.
4. База данных Redis для кэширования запросов.

------

## Инструкция

1. [API сервиса](#API-сервиса)
2. [Тесты API](#Тесты-API)

## API сервиса

1. Создание пользователя. Пароль хэшируется и в таком виде хранится в БД. Пользователю выдается access_token в cookie.\
   **Метод** `POST /auth/register`\
   Параметры:

```
{
  "username": "string",
  "email": "string",
  "password": "string"
}
```

Ответ:

```
{
  "access_token": "string",
  "token_type": "string"
}
```

2. Аутентификация пользователя. Верифицируется acess_token \
   **Метод** `POST /auth/login`\
   Параметры:

```
{
  "username": "string",
  "password": "string"
}
```

Ответ:

```
{
   message: "Hi again in the dark side, we have cookies"
}
```

3. Выход из системы. Логирование пользователя (удаление токена и завершение сессии).\
   **Метод** `POST /auth/logout`

Ответ:

```
{
  "message": "Вы успешно вышли из системы"
}
```

4. Проверка информации пользователя.\
   **Метод** `GET /auth/me`

Если пользователь залогинен, то возвращается информация о пользователе.\
Ответ:

```
{
  "username": "string",
  "email": "string",
}
```

Если пользователь не залогинен, то возвращается ошибка.

```
{
detail: "Произошла ошибка"
status_code: 500
}
```

5. Сокращение ссылки. Если не будут предоставлены short_code и expires_at, то код будет сгенерирован автоматически и
   время жизни ссылки будет установлено полгода. \
   **Метод** `POST /links/shorten`\
   Параметры:

```
{
  "url": "string", (обязательное поле)
  "short_code": "string",
  "expires_at": "string",
}
```

Ответ:

```
{
  "short_code": "string",
  "original_url": "string"
}
```

6. Переход по сокращенной ссылке. Увеличивает счетчик кликов по ссылке\
   **Метод** `GET /links/{short_code}`\
   Параметры:

```
{
  "short_code": "string"
}
```

Ответ: Редирект на оригинальный URL

7. Удаление ссылки. Доступно только авторизованному пользователю.\
   **Метод** `DELETE /links/{short_code}`\
   Параметры:

```
{
  "short_code": "string"
}
```

Ответ: HTTP 204 No Content

8. Изменение шорт кода ссылки. Доступно только авторизованному пользователю.\
   **Метод** `PUT /links/{short_code}`\
   Параметры:

```
{
  "short_code": "string",
  "new_code": "string",
}
```

Ответ:

```
{
"message": "Ссылка обновлена"
}
```

9. Получение статистики для сокращенной ссылки.\
   **Метод** `GET /links/{short_code}/stats`\
   Параметры:

```
{
  "short_code": "string"
}
```

Ответ:

```
[
    {
        "original_url": "yandex.ru",
        "created_at": "2025-03-25 07:56:17.908659",
        "clicks": 1,
        "last_used_at": "None"
    }
]
```

10. Поиск ссылок по URL.\
    **Метод** `GET /links/search/{original_url}`\
    Параметры:

```
{
  "original_url": "string"
}
```

Ответ:

```
[
    {
        "short_code": "string",
        "original_url": "yandex.ru",
        "created_at": "2025-03-25 07:56:17.908659",
        "clicks": 1,
        "last_used_at": "None"
    }
]
```

11. Удаление неиспользуемых ссылок. Доступно только зарегистрированным пользователям. Метод настроен как таска celery,
    чтобы можно было настроить расписание. Таска перемещает неиспользуемые ссылки в архив.\
    **Метод** `POST /links/delete/{days}`\
    Параметры:

```
{
  "days": "int"
}
```   

Ответ:

```
{
  "task_id": "string",
  "status": "task started"
}
```

12. Получение статуса выполнения задачи.\
    **Метод** `GET /links/task-status/{task_id}`\
    Параметры:

```
{
  "task_id": "string"
}
```

Ответ:

```
{
  "status": "SUCCESS"
}
```

13. Получение статистики архивных ссылок.\
    **Метод** `GET /links/history/`\
    Параметры:

Ответ:

```
[
    {
        "short_code": "ya",
        "original_url": "ya.ru",
        "deleted_at": "2025-03-25 11:45:24.681932+00:00",
        "reason": "Неиспользуемая ссылка"
    },
    {
        "short_code": "test1",
        "original_url": "ya.ru",
        "deleted_at": "2025-03-25 11:45:24.682126+00:00",
        "reason": "Неиспользуемая ссылка"
    },
    {
        "short_code": "test",
        "original_url": "ya.ru",
        "deleted_at": "2025-03-25 11:45:24.682170+00:00",
        "reason": "Неиспользуемая ссылка"
    }
]
```

## Демонстрация

1. Деплой на render.com
   ![img.png](img.png)

2. Деплой в docker
   ![img_1.png](img_1.png)

3. Показ работы
   ![bandicam 2025-03-26 11-51-18-857.gif](bandicam%202025-03-26%2011-51-18-857.gif)

## Тесты-API

*tests_api.py*\
В этом файле находятся тесты, которые проверяют работу API. Каждый тест выполняет различные операции с API, такие как
регистрация, логин, получение информации о пользователе и выход из системы.

**test_register_user**
- **Описание**: Проверяет регистрацию нового пользователя.
- **Шаги**:
  1. Отправляется запрос на создание пользователя с указанными данными.
  2. Проверяется, что возвращается токен доступа, и что пользователь был добавлен в базу данных.

---

**test_login_user**
- **Описание**: Проверяет процесс аутентификации (входа).
- **Шаги**:
  1. Сначала создается пользователь.
  2. Затем отправляется запрос на вход с правильными учетными данными.
  3. Проверяется, что возвращается токен доступа.

---

**test_get_current_user_info**
- **Описание**: Проверяет получение информации о текущем пользователе.
- **Шаги**:
  1. Сначала создается и авторизуется пользователь.
  2. Отправляется запрос для получения информации о текущем пользователе, используя токен из куки.
  3. Проверяется, что информация о пользователе возвращается корректно.

---

 **test_logout_user**
- **Описание**: Проверяет выход из системы (удаление токена).
- **Шаги**:
  1. Сначала создается и авторизуется пользователь.
  2. Отправляется запрос на выход, что приводит к удалению токена из куки.
  3. Проверяется, что токен удален и пользователь больше не авторизован.

---

**test_create_link**
- **Описание**: Проверяет создание сокращенной ссылки.
- **Шаги**:
  1. Отправляется запрос на создание сокращенной ссылки.
  2. Проверяется, что возвращаются код короткой ссылки и оригинальный URL.

---

**test_redirect_link**
- **Описание**: Проверяет редирект по сокращенной ссылке.
- **Шаги**:
  1. Сначала создается сокращенная ссылка.
  2. Отправляется GET-запрос с коротким кодом, проверяется редирект на оригинальный URL.

---

**test_delete_link**
- **Описание**: Проверяет удаление сокращенной ссылки.
- **Шаги**:
  1. Сначала создается сокращенная ссылка.
  2. Отправляется запрос на удаление ссылки.
  3. Проверяется, что ссылка больше не доступна и возвращается ошибка `404`.

---

**test_update_link**
- **Описание**: Проверяет обновление сокращенной ссылки.
- **Шаги**:
  1. Сначала создается сокращенная ссылка.
  2. Отправляется запрос на обновление короткого кода.
  3. Проверяется, что редирект теперь работает с новым кодом.

---

**test_get_link_stats**
- **Описание**: Проверяет получение статистики по с